#!/bin/sh

makezip()
{
  NAME=luabidi
  TMPDIR=`mktemp -d /tmp/luabidiXXXXXX`
  TDSSUB=lualatex/luabidi/
  mkdir -p "$TMPDIR"/"$NAME"/tex
  mkdir -p "$TMPDIR"/"$NAME"/doc
  mkdir -p "$TMPDIR"/"$NAME"/tds/tex/"$TDSSUB"
  mkdir -p "$TMPDIR"/"$NAME"/tds/doc/"$TDSSUB"
  filename="$TMPDIR"/"$NAME".zip

  SRCDIR=`realpath \`dirname $0\``
  echo "source $SRCDIR"
  # First the flat structure
  cp -a README.md LICENCE.md "$TMPDIR"/"$NAME"
  cp -a tex/* "$TMPDIR"/"$NAME"/tex
  cp -a doc/* "$TMPDIR"/"$NAME"/doc

  # Compile documentation
  TEXINPUTS=$PWD/tex:$PWD/doc:
  cd "$TMPDIR"/"$NAME"/doc
  lualatex luabidi
  lualatex luabidi
  rm *.{glo,log,out,idx,aux,toc,hd} 2&> /dev/null
  cp -i luabidi.pdf "$TMPDIR"/"$NAME"/doc/luabidi.pdf

  # Now prepare the TDS zip.
#  cd ..
#  cp -a tex/* "$TMPDIR"/"$NAME"/tds/tex/"$TDSSUB"
#  cp -a README.md LICENCE.md doc/* "$TMPDIR"/"$NAME"/tds/doc/"$TDSSUB"
#  cd "$TMPDIR"/"$NAME"/tds
#  zip -ry $NAME.tds.zip *
#  cd ..
#  mv -f tds/$NAME.tds.zip .
#  rm -rf tds
  cd ..
  zip -ry $NAME.zip $NAME
}


if makezip; then
  echo "$filename ready to be shipped to CTAN."
else
  echo "Something went wrong."
fi
